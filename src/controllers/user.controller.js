import { asyncHandler } from "../utils/asyncHandler.js"
import { ApiError } from "../utils/ApiError.js"
import { User } from "../models/user.model.js"
import { uploadOnCloudinary } from "../utils/cloudinary.js"
import { ApiResponse } from "../utils/ApiResponse.js"

const generateAccessAndRefreshTokens = async(userId) => {
    try {
        const user = await User.findById(userId)
        const accessToken = user.generateAccessToken()
        const refreshToken = user.generateRefreshToken()

        user.refreshToken = refreshToken  //generates the new refresh token
        await user.save({ validateBeforeSave: false})//this validateBeforeSave saves the refresh token without reauthenticating by password

        return {accessToken,refreshToken}
    } catch (error) {
        throw new ApiError(500,"something went wrong while generating access and refresh tokens")
    }
}

const registerUser = asyncHandler( async(req,res) => {

    //get user details from frontend 1ï¸âƒ£
    //validation-not empty 2ï¸âƒ£
    //check if user already exists: email,username  3ï¸âƒ£
    //check for images, check for avatar  4ï¸âƒ£
    //upload them to cloudinary:avatar  5ï¸âƒ£
    //create user object-user entry in db  6ï¸âƒ£
    //remove password and refresh token fields from response  7ï¸âƒ£
    //check for user creation  8ï¸âƒ£
    //return res  9ï¸âƒ£ ðŸ”Ÿ


    //1ï¸âƒ£
    const {fullName,username,email,password} = req.body    //get user details from frontend  
    // console.log("email: ",email);  //test

    //2ï¸âƒ£
    if (    //validation that fields are not empty   
        [fullName, email, username, password].some((field) => //.some checks the fields and returns whether they are true
        field ?.trim() === "")//this trim keyword removes spaces from front and behind
    ) {
        throw new ApiError(400,"all fiels are required")
    }

    //3ï¸âƒ£
    const existedUser = await User.findOne({    //checks whether email or username related user already exists in database, and because this method requires access of database thats why we use User model reference
        $or: [{username},{email}]//this automatically checks whether the user of same credentials exists or not
    })

    if (existedUser) {
        throw new ApiError(409, "User with same email or username already exists")
    }

    //
    // console.log(req.files);   //test

    //4ï¸âƒ£
    const avatarLocalPath = req.files?.avatar[0]?.path;  //check the avatar file locally on local path and give that path
    // const coverImageLocalPath = req.files?.coverImage[0]?.path;   //this line is only used when coverImage is compulsory(required: true) instead of optional

    let coverImageLocalPath;   //but the coverImage is optional and thats why this code is used for coverImage
    if(req.files && Array.isArray(req.files.coverImage) && req.files.coverImage.length > 0){
        coverImageLocalPath = req.files.coverImage[0].path;  //this gives the path of coverImage only if it is saved locally
    }

    if(!avatarLocalPath){    //check that avatar file is locally saved or not
        throw new ApiError(400, "Avatar file is required")
    }

    //5ï¸âƒ£
    const avatar = await uploadOnCloudinary(avatarLocalPath)  //uploaded avatar file
    const coverImage = await uploadOnCloudinary(coverImageLocalPath)   //uploaded coverImage file

    if(!avatar){   //check that avatar file is uploaded on cloudinary or not, and cover image is not compulsory(required:true) thats why we dont check it
        throw new ApiError(400, "Avatar file is required (cloud)")
    }

    //6ï¸âƒ£
    const user = await User.create({
        fullName,
        avatar: avatar.url,
        coverImage: coverImage?.url || "",  //we give empty value if user dont upload the cover image, because this field is optional in our model thats why need to handle corner case for reducing error
        email,
        password,
        username: username.toLowerCase()
    })

    //7ï¸âƒ£
    const createdUser = await User.findById(user._id).select( "-password -refreshToken" )//this finds the user on the basis of id generated by mongodb for every user and returns it except the fiels shown in .select method
    
    //8ï¸âƒ£
    if (!createdUser) {  //this checks whether the user successfully created in the db or not
        throw new ApiError(500, "something went wrong while registering the user")
    }

    //9ï¸âƒ£
    return res.status(201).json(   //this sends the response to the user that user is registered sucessfully
        new ApiResponse(200, createdUser, "user registered successfully")
    )


    // res.status(200).json({    //this code is for testing the controller  //test
    //     message: "ok"                                                    //test
    // })                                                                   //test
})

const loginUser = asyncHandler( async(req,res) => {
    //req body - data
    //username or email
    //find the user
    //password check
    //access and refresh token
    //send cookie

    //1ï¸âƒ£
    const { username,email,password } = req.body

    //2ï¸âƒ£
    if(!username && !email){
        throw new ApiError(400,"username or email is required")
    }

    //3ï¸âƒ£
    const user = await User.findOne({
        $or: [{username},{email}]  //these are called mongodb operators, and this finds the user on the basis of either username or email
    })

    if(!user){
        throw new ApiError(400,"User does not exist")
    }

    //4ï¸âƒ£
    const isPasswordValid = await user.isPasswordCorrect(password)

    if(!isPasswordValid){
        throw new ApiError(401,"incorrect user credentials")
    }

    //5ï¸âƒ£
    const {accessToken,refreshToken} = await generateAccessAndRefreshTokens(user._id)

    const loggedInUser = await User.findById(user._id).select("-password -refreshToken")

    //6ï¸âƒ£
    const options = {
        httpOnly: true,
        secure: true
    }

    return res
    .status(200)
    .cookie("accessToken", accessToken, options)
    .cookie("refreshToken", refreshToken, options)
    .json(
        new ApiResponse(
            200,
            {
                user: loggedInUser
            },
            "User logged in successfully"
        )
    )

})

const logoutUser = asyncHandler( async(req,res) => {
    await User.findByIdAndUpdate(req.user._id,  //this used instead of findById is because it directly updates by finding the user without returning it, unlike findById which finds and returns the user
        {
            $set: {
                refreshToken: undefined
            }
        },
        {
            new: true
        }
    )

    const options = {
        httpOnly: true,
        secure: true
    }

    return res
    .status(200)
    .clearCookie("accessToken", options)
    .clearCookie("refreshToken", options)
    .json(new ApiResponse(200, {}, "User logged out"))
})

export { registerUser,loginUser,logoutUser }