import { asyncHandler } from "../utils/asyncHandler.js"
import { ApiError } from "../utils/ApiError.js"
import { User } from "../models/user.model.js"
import { uploadOnCloudinary } from "../utils/cloudinary.js"
import { ApiResponse } from "../utils/ApiResponse.js"

const registerUser = asyncHandler( async(req,res) => {

    //get user details from frontend 1Ô∏è‚É£
    //validation-not empty 2Ô∏è‚É£
    //check if user already exists: email,username  3Ô∏è‚É£
    //check for images, check for avatar  4Ô∏è‚É£
    //upload them to cloudinary:avatar  5Ô∏è‚É£
    //create user object-user entry in db  6Ô∏è‚É£
    //remove password and refresh token fields from response  7Ô∏è‚É£
    //check for user creation  8Ô∏è‚É£
    //return res  9Ô∏è‚É£ üîü


    //1Ô∏è‚É£
    const {fullName,username,email,password} = req.body    //get user details from frontend  
    // console.log("email: ",email);  //test

    //2Ô∏è‚É£
    if (    //validation that fields are not empty   
        [fullName, email, username, password].some((field) => //.some checks the fields and returns whether they are true
        field ?.trim() === "")//this trim keyword removes spaces from front and behind
    ) {
        throw new ApiError(400,"all fiels are required")
    }

    //3Ô∏è‚É£
    const existedUser = await User.findOne({    //checks whether email or username related user already exists in database, and because this method requires access of database thats why we use User model reference
        $or: [{username},{email}]//this automatically checks whether the user of same credentials exists or not
    })

    if (existedUser) {
        throw new ApiError(409, "User with same email or username already exists")
    }

    //
    // console.log(req.files);   //test

    //4Ô∏è‚É£
    const avatarLocalPath = req.files?.avatar[0]?.path;  //check the avatar file locally on local path and give that path
    // const coverImageLocalPath = req.files?.coverImage[0]?.path;   //this line is only used when coverImage is compulsory(required: true) instead of optional

    let coverImageLocalPath;   //but the coverImage is optional and thats why this code is used for coverImage
    if(req.files && Array.isArray(req.files.coverImage) && req.files.coverImage.length > 0){
        coverImageLocalPath = req.files.coverImage[0].path;  //this gives the path of coverImage only if it is saved locally
    }

    if(!avatarLocalPath){    //check that avatar file is locally saved or not
        throw new ApiError(400, "Avatar file is required")
    }

    //5Ô∏è‚É£
    const avatar = await uploadOnCloudinary(avatarLocalPath)  //uploaded avatar file
    const coverImage = await uploadOnCloudinary(coverImageLocalPath)   //uploaded coverImage file

    if(!avatar){   //check that avatar file is uploaded on cloudinary or not, and cover image is not compulsory(required:true) thats why we dont check it
        throw new ApiError(400, "Avatar file is required (cloud)")
    }

    //6Ô∏è‚É£
    const user = await User.create({
        fullName,
        avatar: avatar.url,
        coverImage: coverImage?.url || "",  //we give empty value if user dont upload the cover image, because this field is optional in our model thats why need to handle corner case for reducing error
        email,
        password,
        username: username.toLowerCase()
    })

    //7Ô∏è‚É£
    const createdUser = await User.findById(user._id).select( "-password -refreshToken" )//this finds the user on the basis of id generated by mongodb for every user and returns it except the fiels shown in .select method
    
    //8Ô∏è‚É£
    if (!createdUser) {  //this checks whether the user successfully created in the db or not
        throw new ApiError(500, "something went wrong while registering the user")
    }

    //9Ô∏è‚É£
    return res.status(201).json(   //this sends the response to the user that user is registered sucessfully
        new ApiResponse(200, createdUser, "user registered successfully")
    )


    // res.status(200).json({    //this code is for testing the controller  //test
    //     message: "ok"                                                    //test
    // })                                                                   //test
})

export { registerUser }